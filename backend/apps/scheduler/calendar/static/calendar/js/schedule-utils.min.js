let gXhr=null;function resetEventForm(b,a){$("#add_schedule_form_container").html($("template#form_main_template").html());getFormContent(a);initMap();if(a==="advanced"){$("#mode_toggle_btn").hide()}}function fillParticipantList(b){var d={L:"Prowadzący",P:"Uczestnik"};var a=$("#event-user-list-row-template").html();a=a.replace(/__user_id__/g,b.id);a=a.replace(/__user_name__/g,b.first_name+" "+b.last_name);a=a.replace("__user_phone_one__",b.phone_one);a=a.replace("__user_phone_two__",b.phone_two);a=a.replace("__user_email__",b.email);a=a.replace("__participant_type_label__",d[b.participant_type]);a=a.replace("__participant_type__",b.participant_type);a=a.replace(/__user_confirmation__/g,b.confirmed?"check":"times");a=a.replace(/__user_confirmed__/g,b.confirmed?"1":"0");a=a.replace(/__active__/g,b.active?"active":"");a=a.replace(/__opacity__/g,b.active?"":"opacity40");a=a.replace(/__current_participant__/g,(parseInt(b.id)===parseInt(window.id_current_user))?"current-participant":"");a=a.replace("__exclusive_participant_mode_checked__",b.exclusive_participant_mode?"checked":"");a=a.replace("__exclusive_participant_mode_value__",b.exclusive_participant_mode?"1":"0");return a}function fillCustomLocationAddress(a){$("form#schedule-form #id_address-street").val(a.street);$("form#schedule-form #id_address-street_no").val(a.street_no);$("form#schedule-form #id_address-apartment_no").val(a.apartment_no);$("form#schedule-form #id_address-city").val(a.city);$("form#schedule-form #id_address-province").val(a.province);$("form#schedule-form #id_address-post_code").val(a.post_code);$("form#schedule-form #id_address-country").val(a.country);$("form#schedule-form #id_address-email").val(a.email);$("form#schedule-form #id_address-phone").val(a.phone)}function convertHourToMinutes(b){if(!moment.isMoment(b)){return 0}var a=b.get("hour");var d=b.get("minute");return a*60+d}function fillEventData(a,b){$("#event-user-list-row-table tbody").html(null);let e=a.schedule.fields;let t=a.event_type;let c=a.custom_address?a.custom_address.fields:null;let m=a.meeting_room?a.meeting_room:null;let u=a.users;let ms=a.messages;$("form#schedule-form #id").val(b.id);$("form#schedule-form #editable").val(b.editable);$("form#schedule-form #id_created_by").val(e.created_by);$("form#schedule-form #status").val(e.status);$("form#schedule-form #created_by-container h5 span").text(a.created_by);$('form#schedule-form #id_schedule-host_user option[value="'+e.host_user+'"]').attr("selected",true);$('form#schedule-form #id_schedule-type option[value="'+t.pk+'"]').attr("selected",true);$("form#schedule-form #id_schedule-type option").not(":selected").remove();$("form#schedule-form #id_schedule-title").val(e.title);$('form#schedule-form #id_schedule-meeting_room option[value="'+e.meeting_room+'"]').attr("selected",true);$("form#schedule-form #id_schedule-start_date").data("DateTimePicker").date(e.start_date);$("form#schedule-form #id_schedule-end_date").data("DateTimePicker").date(e.end_date);$("#id_schedule-end_date").data("DateTimePicker").minDate(moment(e.start_date).add(15,"minutes").format("YYYY-MM-DD HH:mm"));$("form#schedule-form #id_schedule-description").val(e.description);if(m){$('form#schedule-form #id_schedule-headquarter option[value="'+m.fields.headquarter+'"]').prop("selected",true);setMeetingRoom(m.pk)}else{if(c){fillCustomLocationAddress(c)}}if(u){$.each(u,function(d,f){f.active=parseInt(f.id)===parseInt(window.id_current_user)||window.permissions.toggle_confirm_all;$("#event-user-list-row-table").find("tbody").append(fillParticipantList(f))})}if(ms){$.each(ms,function(d,g){var f=$("#event-message-container").find("ul#event_messages");f.append('<li><div class="event-message-header">'+g.created_date+" "+g.user+'</div><div class="event-message-text">'+g.text+"</div></li>")})}}function fillAddressForm(b,a,g){var h=[];for(var f=0;f<b.address_components.length;f++){var d=b.address_components[f].types[0];if(a[d]){var j=b.address_components[f][a[d]];h[d]=j}}h.lat=b.geometry.location.lat();h.lng=b.geometry.location.lng();$("#id_address-street").val(h.route);$("#id_address-street_no").val(h.street_number);$("#id_address-city").val(h.administrative_area_level_2);$("#id_address-province").val(h.administrative_area_level_1);$("#id_address-country").val(h.country);$("#id_address-post_code").val(h.postal_code);return h}function setAvailableMeetingRooms(a){$(".meeting-room-btn").removeClass("disabled");$(".meeting-room-btn input[type=radio]").removeAttr("disabled");$.each($('form#schedule-form input:radio[name="schedule-meeting_room"]'),function(b,d){if($.inArray(parseInt($(d).val()),a)===-1){disableMeetingRoom($(d).val())}})}function setMeetingRoomHeadquarter(){let hdq=$("form#schedule-form #id_schedule-headquarter").val();$(".meeting-room-select-buttons .headquarter-meeting_room-container").hide();$(".meeting-room-select-buttons #headquarter_"+hdq).show()}function getAvailableMeetingRooms(b,a){if(!b||!a){return}$.ajax({url:urlGetAvailableMeetingRooms,method:"post",data:{start:b,end:a,exclude:$("form#schedule-form #id").val()}}).done(function(d){setAvailableMeetingRooms(d.data)}).fail(function(d){var f=d.responseJSON;swal(f.errmsg,"","warning")})}function setInitialData(b,a){let schedule_form=$("form#schedule-form");schedule_form.find("#mode").val("basic");schedule_form.find('#id_schedule-host_user option[value="'+gUser.id+'"]').prop("selected",true);let eventType=schedule_form.find('#id_schedule-type option[value="'+gDefaultMeetingEventId+'"]');eventType.prop("selected",true);schedule_form.find("#id_schedule-title").val(eventType.data("default_title")?eventType.data("default_title"):"Spotkanie");$("#created_by-container").find("span").text(gUser.firstName+" "+gUser.lastName);$("form#schedule-form input#id_"+g_form_prefix+"-start_date").data("DateTimePicker").date(b.utc());$("form#schedule-form input#id_"+g_form_prefix+"-end_date").data("DateTimePicker").date(a.utc());$("#id_schedule-end_date").data("DateTimePicker").minDate(b.add(15,"minutes").utc());setMeetingRoomHeadquarter()}function setEventFormAccess(a){let schedule_form=$("form#schedule-form");let e=schedule_form.find("#id_schedule-type option:selected");if(!a){schedule_form.find("#id_schedule-title").val((e.data("default_title")!==null&&e.data("default_title")!=="")?e.data("default_title"):e.val())}if(e.data("title_required")==="True"){schedule_form.find("#id_schedule-title").removeAttr("readonly")}if(e.data("location_required")==="False"){clear_form_elements("#eventLocationCollapse");toggle_form_elements("#eventLocationCollapse",false);schedule_form.find("#event_location_panel").hide()}else{toggle_form_elements("#eventLocationCollapse",true);schedule_form.find("#event_location_panel").show()}if(e.data("single_person")==="True"){schedule_form.find("#event-user-list-row-table tbody").html(null);schedule_form.find("#search-box").attr("disabled",true);schedule_form.find("#event_users_panel").hide()}else{schedule_form.find("#search-box").removeAttr("disabled");schedule_form.find("#event_users_panel").show()}if(schedule_form.find("#id").val()){if(schedule_form.find("#status").val()==="AN"){schedule_form.find("#activate-btn").show()}else{schedule_form.find("#activate-btn").hide()}if(schedule_form.find("#editable").val()==="true"){schedule_form.find("#submit-btn").show();schedule_form.find("#cancel-btn").show();schedule_form.find("#cancel_and_set-btn").show();schedule_form.find("#close-btn").show();schedule_form.find("#delete-btn").show();let endDt=moment(schedule_form.find("#id_schedule-end_date").val()+$("form#schedule-form #start_date").text(),"YYYY-MM-DDHH:mm").toDate();if(endDt>moment()){schedule_form.find("#close-btn").hide()}}else{schedule_form.find("#submit-btn").hide();schedule_form.find("#cancel-btn").hide();schedule_form.find("#cancel_and_set-btn").hide();schedule_form.find("#close-btn").hide();schedule_form.find("#delete-btn").hide()}}else{schedule_form.find("#submit-btn").show();schedule_form.find("#cancel-btn").hide();schedule_form.find("#cancel_and_set-btn").hide();schedule_form.find("#close-btn").hide();schedule_form.find("#delete-btn").hide();schedule_form.find("#activate-btn").hide()}}function eventDataDecode(d){let guide=["id","title","start","end","color","viewable","editable","data"];let dataGuide=["single_person","confirmed","host_user","address","resizable","status","invited_users"];let userGuide=["pk","first_name","last_name","email","phone_one","_edit_link"];function b(f){let user={};$.each(f,function(g,h){user[userGuide[g]]=h});return user}function a(f){let invitedUsers=[];$.each(f,function(g,h){invitedUsers.push(b(h))});return invitedUsers}let _event={};$.each(d,function(f,g){switch(guide[f]){case"data":let _ev={};$.each(g,function(i,h){switch(dataGuide[i]){case"host_user":_ev[dataGuide[i]]=b(h);break;case"invited_users":_ev[dataGuide[i]]=a(h);break;default:_ev[dataGuide[i]]=h;break}});_event.data=_ev;break;default:_event[guide[f]]=g;break}});return _event}function getHeadquarters(){return $("#user_headquarters_list").val()}function getEvents(d,a,b){if(calendar_mode==="dates"){b(availableDates);return}let data={start:d.format("YYYY-MM-DD"),end:a.format("YYYY-MM-DD"),id_user:window.id_user,csrfmiddlewaretoken:window.csrf_token,calendar_mode:calendar_mode,filter_phrase:$("#scheduleFilterModal").find("#event_filter_phrase").val(),headquarter:getHeadquarters()};if(gXhr){gXhr.abort()}gXhr=$.ajax({url:"/schedule/calendar/get-events/",type:"POST",data:data,success:function(f){let events=[];$.each(f.events,function(g,h){let _event=eventDataDecode(h);events.push(_event)});b(events)},error:function(g,h,f){if(g.statusText==="abort"){return}swal(h,"","error")},complete:function(){}})}function getAvailableDates(){$.ajax({type:"post",url:"/schedule/get-available-date/",data:{employee_id:$("#id_filter-employee").val(),user_id:$("#id_filter-user").val(),meeting_room_id:$("#id_filter-meeting_room").val(),from_date:$("#id_filter-from_date").val(),from_hour:$("#id_filter-from_hour").val(),to_hour:$("#id_filter-to_hour").val(),min_duration:$("#id_filter-min_duration").val()},error:function(a,d,b){if(a.statusText==="abort"){return}console.log(a.statusText);if(a.statusText==="abort"){return}swal(a.errmsg,"","error")}}).done(function(a){var b=a.ranges.length;availableDates=[];if(!b){swal("Nie ma możliwości ustalenia terminu dla wskazanych kryteriów","","info");calendar_mode="event";$("#calendar").fullCalendar("refetchEvents");$("#available_date_reset_btn").hide();return}$.each(a.ranges,function(d,f){event={start:f.start,end:f.end,color:d===(b-1)?"#4c8e05":"#7ce40c",rendering:"background"};availableDates.push(event)});calendar_mode="dates";$("#calendar").fullCalendar("gotoDate",availableDates[0].start);$("#calendar").fullCalendar("refetchEvents");$("#available_date_reset_btn").show();let modal=$("#available_date_modal");let ul=modal.find("#available_date_list");ul.html(null);$.each(a.ranges,function(d,f){ul.append('<li><a href="#" data-date="'+f.start.substr(0,10)+'">'+f.start+" - "+f.end+"</a></li>")});modal.modal()})}function getFormContent(d){let scheduleForm=$("form#schedule-form");let startDate=scheduleForm.find("#id_schedule-start_date").val();let endDate=scheduleForm.find("#id_schedule-end_date").val();let type=scheduleForm.find("#id_schedule-type").val();let title=scheduleForm.find("#id_schedule-title").val();let hostUser=scheduleForm.find("#id_schedule-host_user").val();let meetingRoom=scheduleForm.find('input[name="schedule-meeting_room"]:checked').val();let service=scheduleForm.find("#id_schedule-service").val();function a(){if(d==="basic"){$("#add_schedule_form_container").find("#form_content").html($("template#form_basic_template").html())}else{if(d==="advanced"){$("#add_schedule_form_container").find("#form_content").html($("template#form_advanced_template").html())}}setCalendarDatetimePicker($("form#schedule-form input#id_schedule-start_date"));setCalendarDatetimePicker($("form#schedule-form input#id_schedule-end_date"));$("#id_schedule-start_date").datetimepicker().on("dp.change",function(f){$("#id_schedule-end_date").data("DateTimePicker").minDate(f.date.add(15,"minutes").toDate());let end=$("#id_schedule-end_date").data("DateTimePicker").date();if(!end||(end<$("#id_schedule-start_date").data("DateTimePicker").date().utc())){$("#id_schedule-end_date").data("DateTimePicker").date($("#id_schedule-end_date").data("DateTimePicker").minDate().toDate())}getAvailableMeetingRooms($("form#schedule-form #id_schedule-start_date").val(),$("form#schedule-form #id_schedule-end_date").val())});$("#id_schedule-end_date").datetimepicker().on("dp.change",function(f){getAvailableMeetingRooms($("form#schedule-form #id_schedule-start_date").val(),$("form#schedule-form #id_schedule-end_date").val())});$("#id_schedule-host_user_, #id_schedule-employee_").select2({ajax:{method:"post",url:"/schedule/get-employees-for-meeting-filter/",dataType:"json"},minimumInputLength:2,language:"pl",width:"100%"});$("#id_schedule-client_").select2({ajax:{method:"post",url:"/schedule/get-clients-for-meeting-filter/",dataType:"json"},minimumInputLength:2,language:"pl",width:"100%"})}function b(){scheduleForm.find("#id_schedule-start_date").val(startDate);scheduleForm.find("#id_schedule-end_date").val(endDate);scheduleForm.find("#id_schedule-title").val(title);scheduleForm.find('#id_schedule-type option[value="'+type+'"]').prop("selected",true);scheduleForm.find('#id_schedule-host_user option[value="'+hostUser+'"]').prop("selected",true);scheduleForm.find('#id_schedule-service option[value="'+service+'"]').prop("selected",true);if(meetingRoom){setMeetingRoom(meetingRoom)}getAvailableMeetingRooms(startDate,endDate)}a();b()};